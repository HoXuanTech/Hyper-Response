<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>紅綠燈反應遊戲（含挑戰級）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
           background:#0f1115; color:#e9eef6; margin:0; padding:40px 20px; }
    .wrap{ max-width:720px; margin:0 auto; background:#171922; border:1px solid rgba(255,255,255,.08);
           border-radius:20px; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,.45);}
    h1{ margin:0 0 8px; font-size:26px }
    p{ margin:6px 0; color:#9aa7b2}
    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
    select, button{ font-size:16px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
                    background:#1c2130; color:#e9eef6; padding:10px 14px; }
    button{ cursor:pointer; background:linear-gradient(135deg,#3b82f6,#8b5cf6); border:none;
            box-shadow:0 10px 20px rgba(59,130,246,.25); transition:transform .06s, filter .2s}
    button:hover{ filter:brightness(1.05) } button:active{ transform:translateY(1px) scale(.99) }
    .arena{ margin:18px 0 10px; display:grid; place-items:center; height:320px; border-radius:18px;
            background:#2a2f3a; user-select:none; }
    .light{ width:160px; height:160px; border-radius:50%; box-shadow:inset 0 0 30px rgba(0,0,0,.5);
            transition: background .15s, box-shadow .15s }
    .red{ background:#e53935; box-shadow:0 0 30px rgba(229,57,53,.65), inset 0 0 30px rgba(0,0,0,.5) }
    .yellow{ background:#fbbf24; box-shadow:0 0 30px rgba(251,191,36,.6), inset 0 0 30px rgba(0,0,0,.5) }
    .green{ background:#22c55e; box-shadow:0 0 30px rgba(34,197,94,.6), inset 0 0 30px rgba(0,0,0,.5) }
    .hint{ margin-top:14px; font-weight:700; font-size:18px }
    #result{ margin-top:8px; font-size:18px }
    /* 犯規鬼臉 */
    #demonFace{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.85);
      width:220px; max-width:45vw; opacity:0; pointer-events:none; z-index:99;
      filter:drop-shadow(0 0 16px rgba(229,57,53,.9)) saturate(1.1);
      transition:opacity .18s ease, transform .18s ease;
    }
    .show-demon{ opacity:1 !important; animation:shake .3s infinite; transform:translate(-50%,-50%) scale(1); }
    @keyframes shake{
      0%,100%{ transform:translate(-50%,-50%) scale(1) rotate(0deg); }
      25%{ transform:translate(-50%,-50%) scale(1.02) rotate(8deg); }
      50%{ transform:translate(-50%,-50%) scale(1) rotate(-8deg); }
      75%{ transform:translate(-50%,-50%) scale(1.02) rotate(6deg); }
    }
    .muted{ color:#9aa7b2 }
  </style>
</head>
<body>
  <!-- 犯規鬼臉（請在 repo 放 demon.png 與本檔同層） -->
  <img id="demonFace" src="demon.png" alt="犯規！"/>

  <div class="wrap">
    <h1>紅綠燈反應遊戲 🚦</h1>
    <p>只有<strong>綠燈</strong>可以按。紅燈或黃燈按下會被鬼臉指責 👹</p>

    <div class="topbar">
      <label>等級：
        <select id="level">
          <option value="normal">一般</option>
          <option value="challenge">挑戰級（可能先亮黃燈）</option>
        </select>
      </label>
      <button id="startBtn">開始</button>
      <button id="tapBtn">我按了！</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="arena" id="arena">
      <div id="light" class="light red"></div>
      <div class="hint" id="hint">按「開始」準備</div>
    </div>

    <div id="result"></div>
    <p class="muted">小技巧：挑戰級會隨機出現黃燈 0.3–0.8 秒，別被騙了！</p>
  </div>

<script>
(() => {
  const light = document.getElementById('light');
  const startBtn = document.getElementById('startBtn');
  const tapBtn = document.getElementById('tapBtn');
  const levelSel = document.getElementById('level');
  const hint = document.getElementById('hint');
  const result = document.getElementById('result');
  const statusEl = document.getElementById('status');
  const demonFace = document.getElementById('demonFace');

  let current = 'red';      // 'red' | 'yellow' | 'green'
  let startTime = 0;        // 綠燈開始時間
  let timerA = null;        // 計時器：等綠或黃
  let timerB = null;        // 計時器：黃轉綠
  let playing = false;

  const AC = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AC();
  const now = () => audioCtx.currentTime;
  function beep(freq=880, dur=0.08, type='sine', gain=0.08){
    const t0 = now(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0, t0); g.gain.linearRampToValueAtTime(gain, t0 + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination); o.start(t0); o.stop(t0 + dur + 0.02);
  }
  const sndReady = ()=>beep(1200,0.09,'triangle',0.10);
  const sndFoul  = ()=>beep(200, 0.12,'square',0.12);
  const sndGood  = ()=>{beep(900,0.06,'sine',0.08); beep(1200,0.06,'sine',0.08);};

  function setLight(color){
    current = color;
    light.className = 'light ' + color;
    if(color==='red')   hint.textContent = '等候中…（不要按）';
    if(color==='yellow')hint.textContent = '小心！還沒綠！';
    if(color==='green') hint.textContent = '現在！快按！';
  }

  function showDemon(){
    demonFace.classList.add('show-demon');
    setTimeout(()=>demonFace.classList.remove('show-demon'), 1500);
  }

  function reset(){
    clearTimeout(timerA); clearTimeout(timerB);
    timerA = timerB = null;
    playing = false;
    setLight('red');
    statusEl.textContent = '';
  }

  function startGame(){
    audioCtx.resume();
    reset();
    playing = true;
    result.textContent = '';
    statusEl.textContent = '準備…';
    // 隨機等待：一般 1~2.5s；挑戰級 1~3s
    const delay = (levelSel.value==='challenge')
      ? (1000 + Math.random()*2000)
      : (1000 + Math.random()*1500);

    timerA = setTimeout(()=>{
      if(levelSel.value==='challenge' && Math.random()<0.55){
        // 先亮黃燈 0.3~0.8s 再轉綠
        setLight('yellow');
        timerB = setTimeout(()=>{
          setLight('green'); sndReady();
          startTime = performance.now();
        }, 300 + Math.random()*500);
      }else{
        // 直接綠燈
        setLight('green'); sndReady();
        startTime = performance.now();
      }
    }, delay);
  }

  function foul(reason='犯規！'){
    sndFoul();
    showDemon();
    result.textContent = reason + '（只能在綠燈按）';
    reset();
  }

  function handleTap(){
    audioCtx.resume();
    if(!playing){ result.textContent='請先按「開始」'; return; }
    if(current!=='green'){ return foul(current==='yellow' ? '黃燈按下' : '太早了'); }
    // 合法
    const rt = Math.round(performance.now() - startTime);
    sndGood();
    result.textContent = `你的反應時間：${rt} ms`;
    statusEl.textContent = '做得好！再來一局？';
    reset();
  }

  startBtn.addEventListener('click', startGame);
  tapBtn.addEventListener('click', handleTap);
  // 也允許直接點燈區域
  document.getElementById('arena').addEventListener('click', handleTap);
})();
</script>
</body>
</html>
